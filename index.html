<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mappa Firenze</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<style>
html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; font-size: 8pt; }
#map { height: 100vh; }
.legend {
  position: absolute; bottom: 15px; right: 15px;
  background: rgba(255,255,255,0.9); border: 1px solid #ccc;
  border-radius: 8px; padding: 6px 10px; font-size: 8pt;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1); z-index: 1000;
}
.locate-btn, .stop-btn {
  position: absolute; right: 15px; background: white;
  border: 1px solid #ccc; border-radius: 6px;
  padding: 6px 10px; cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  font-weight: 600; z-index: 1000; font-size: 8pt;
}
.locate-btn { top: 15px; color: #1d4ed8; }
.stop-btn { top: 55px; color: #dc2626; }
.locate-btn:hover, .stop-btn:hover { background: #f0f0f0; }
.search-box {
  position: absolute; top: 15px; left: 15px; z-index: 1000;
  background: white; border: 1px solid #ccc; border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  padding: 6px; display: flex; flex-direction: column; width: 200px;
}
.search-input { display: flex; gap: 4px; }
.search-input input {
  border: 1px solid #ccc; border-radius: 4px;
  padding: 4px 6px; font-size: 8pt; flex: 1;
}
.search-input button {
  background: #1d4ed8; color: white; border: none;
  border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 8pt;
}
.search-input button:hover { background: #2563eb; }
.suggestions { margin-top: 4px; border-top: 1px solid #ddd; max-height: 150px; overflow-y: auto; }
.suggestions div { padding: 4px 6px; cursor: pointer; }
.suggestions div:hover { background: #f0f0f0; }
.leaflet-routing-container { font-family: Arial; font-size: 8pt; margin-top: 90px !important; }
.route-btn { background: #1d4ed8; color: white; border: none; border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 8pt; margin-top: 3px; }
.route-btn:hover { background: #2563eb; }
.leaflet-control-zoom {
  position: absolute !important; top: 80px !important; left: 15px !important; z-index: 1000 !important;
}
.route-choice {
  position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%);
  background: rgba(255,255,255,0.95); border: 1px solid #ccc; border-radius: 8px;
  padding: 8px 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  font-size: 8pt; display: flex; gap: 8px; z-index: 1500; align-items: center;
}
.route-choice button {
  border: none; border-radius: 6px; cursor: pointer; padding: 6px 10px; font-weight: bold; font-size: 8pt;
}
.btn-walk { background: #2563eb; color: white; }
.btn-drive { background: #16a34a; color: white; }
.btn-walk:hover { background: #1e40af; }
.btn-drive:hover { background: #15803d; }
</style>
</head>
<body>
<div id="map"></div>

<div class="search-box">
  <div class="search-input">
    <input type="text" id="ricerca" placeholder="Cerca un punto..." oninput="aggiornaSuggerimenti()" />
    <button onclick="cercaPunto()">Cerca</button>
  </div>
  <div id="suggerimenti" class="suggestions"></div>
</div>

<div class="legend">
  <span style="color:red;">‚óè</span> Ristoranti<br>
  <span style="color:green;">‚óè</span> Hotel<br>
  <span style="color:blue;">‚óè</span> Parchi e giardini
</div>

<button class="locate-btn" onclick="trovaPosizione()">üìç Trova la mia posizione</button>
<button class="stop-btn" onclick="fermaPosizione()">üõë Stop tracciamento</button>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
const map = L.map('map').setView([43.77, 11.25], 14);

L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  maxZoom: 20,
  attribution: '&copy; OpenStreetMap contributors, &copy; CartoDB'
}).addTo(map);

const punti = [
  ["Vini e Vecchi Sapori", 43.77011014, 11.25681381, "red", "https://it.tripadvisor.ch/Restaurant_Review-g187895-d1110760-Reviews-Osteria_Vini_e_Vecchi_Sapori-Florence_Tuscany.html"],
  ["Il Latini", 43.77178234, 11.24922621, "red", "https://it.tripadvisor.ch/Restaurant_Review-g187895-d1088252-Reviews-Il_Latini-Florence_Tuscany.html"],
  ["ARTE' Boutique Hotel", 43.77572356, 11.25666108, "green", "https://it.tripadvisor.ch/Hotel_Review-g187895-d17336552-Reviews-Arte_Boutique_Hotel-Florence_Tuscany.html"],
  ["I giardini di Boboli", 43.76255141, 11.24836741, "blue", "https://www.uffizi.it/giardino-boboli"]
];

function markerColor(color) {
  return L.divIcon({
    className: '',
    html: `<svg xmlns='http://www.w3.org/2000/svg' width='25' height='41' viewBox='0 0 25 41'>
      <path d='M12.5 0C5.6 0 0 5.6 0 12.5C0 22 12.5 41 12.5 41C12.5 41 25 22 25 12.5C25 5.6 19.4 0 12.5 0Z'
      fill='${color}' stroke='black' stroke-width='1'/>
      <circle cx='12.5' cy='12.5' r='5' fill='white' stroke='black' stroke-width='1'/>
    </svg>`,
    iconSize: [25, 41], iconAnchor: [12, 41]
  });
}

const markers = [];
punti.forEach(([nome, lat, lon, colore, link]) => {
  const m = L.marker([lat, lon], { icon: markerColor(colore) }).addTo(map);
  m.bindTooltip(nome, { permanent: true, direction: 'top', offset: [0, -10], className: 'label' });
  m.bindPopup(`
    <strong>${nome}</strong><br>
    <a href="${link}" target="_blank">Apri sito</a><br>
    <button class="route-btn" onclick="vaiA(${lat}, ${lon})">Vai üöóüö∂‚Äç‚ôÇÔ∏è</button>
  `);
  markers.push({ nome, marker: m });
});

const group = L.featureGroup(markers.map(m => m.marker));
map.fitBounds(group.getBounds(), { padding: [30, 30] });

// Ricerca
function aggiornaSuggerimenti() {
  const q = document.getElementById('ricerca').value.toLowerCase();
  const sug = document.getElementById('suggerimenti');
  sug.innerHTML = '';
  if (!q) return;
  markers.filter(m => m.nome.toLowerCase().includes(q)).forEach(r => {
    const d = document.createElement('div');
    d.textContent = r.nome;
    d.onclick = () => {
      map.setView(r.marker.getLatLng(), 17);
      r.marker.openPopup();
      document.getElementById('ricerca').value = '';
      sug.innerHTML = '';
    };
    sug.appendChild(d);
  });
}

function cercaPunto() {
  const q = document.getElementById('ricerca').value.toLowerCase();
  const trovato = markers.find(m => m.nome.toLowerCase().includes(q));
  if (trovato) {
    map.setView(trovato.marker.getLatLng(), 17);
    trovato.marker.openPopup();
    document.getElementById('ricerca').value = '';
    document.getElementById('suggerimenti').innerHTML = '';
  } else alert("Nessun punto trovato.");
}

// Posizione e routing
let routingControl = null;
function trovaPosizione() {
  map.locate({ setView: true, watch: true, enableHighAccuracy: true });
  map.on('locationfound', e => {
    if (!window.userMarker) {
      window.userMarker = L.marker(e.latlng).addTo(map).bindPopup("Sei qui").openPopup();
    } else window.userMarker.setLatLng(e.latlng);
  });
}
function fermaPosizione() { map.stopLocate(); if (window.userMarker) map.removeLayer(window.userMarker); if (routingControl) map.removeControl(routingControl); }

function vaiA(destLat, destLon) {
  if (!navigator.geolocation) return alert("Geolocalizzazione non supportata.");
  if (document.querySelector(".route-choice")) document.querySelector(".route-choice").remove();

  const box = document.createElement("div");
  box.className = "route-choice";
  box.innerHTML = `
    <span><strong>Calcola percorso:</strong></span>
    <button class="btn-walk" onclick="calcolaPercorso('foot', ${destLat}, ${destLon})">üö∂‚Äç‚ôÇÔ∏è A piedi</button>
    <button class="btn-drive" onclick="calcolaPercorso('car', ${destLat}, ${destLon})">üöó In auto</button>`;
  document.body.appendChild(box);
}

function calcolaPercorso(modalita, destLat, destLon) {
  navigator.geolocation.getCurrentPosition(pos => {
    const start = L.latLng(pos.coords.latitude, pos.coords.longitude);
    const end = L.latLng(destLat, destLon);
    if (routingControl) map.removeControl(routingControl);
    document.querySelector(".route-choice")?.remove();

    // versione HTTPS compatibile OSRM
    const serviceUrl = `https://routing.openstreetmap.de/routed-${modalita}/route/v1/driving/`;

    routingControl = L.Routing.control({
      waypoints: [start, end],
      router: new L.Routing.OSRMv1({
        serviceUrl: `https://routing.openstreetmap.de/routed-${modalita}/route/v1/driving`,
      }),
      lineOptions: { styles: [{ color: "#1d4ed8", opacity: 0.8, weight: 5 }] },
      routeWhileDragging: false,
      show: true,
      addWaypoints: false,
      fitSelectedRoutes: true,
      language: 'it',
      position: 'topright'
    }).addTo(map);
  }, () => alert("Impossibile determinare la tua posizione."));
}
</script>
</body>
</html>
